require("dotenv").config();

const {
    GoogleGenerativeAI,
    HarmCategory,
    HarmBlockThreshold,
  } = require("@google/generative-ai");
  
  const apiKey = process.env.GEMINI_API_KEY;
  const genAI = new GoogleGenerativeAI(apiKey);
  
  const model = genAI.getGenerativeModel({
    model: "gemini-2.0-flash",
  });
  
  const generationConfig = {
    temperature: 1,
    topP: 0.95,
    topK: 40,
    maxOutputTokens: 8192,
    responseMimeType: "text/plain",
  };
  
  async function run(prompt) {
    const chatSession = model.startChat({
      generationConfig,
      history: [
        {
          role: "user",
          parts: [
            {text: "[{\n  \"_id\": {\n    \"$oid\": \"679bba9c0b78614257ca4da1\"\n  },\n  \"policyholderId\": [],\n  \"policyName\": \"Car Insurance\",\n  \"policyDescription\": \"Full coverage for your vehicle, including accidents, theft, and natural disasters.\",\n  \"coverageAmount\": 100000,\n  \"startDate\": {\n    \"$date\": \"2022-06-15T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2025-06-15T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.bajajallianz.com/blog/wp-content/uploads/2022/05/zero-contact-process.jpg\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T17:45:00.624Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-24T08:35:12.926Z\"\n  },\n  \"__v\": 8\n},\n{\n  \"_id\": {\n    \"$oid\": \"679bbe2cd8868e0b6de16555\"\n  },\n  \"policyholderId\": [],\n  \"policyName\": \"Home Insurance\",\n  \"policyDescription\": \"Protects your home from fire, theft, and natural calamities.\",\n  \"coverageAmount\": 200000,\n  \"startDate\": {\n    \"$date\": \"2022-08-01T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2025-08-01T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://5.imimg.com/data5/SELLER/Default/2024/7/437521164/ZO/HV/LW/22828373/home-insurance-500x500.png\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T18:00:12.452Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-26T08:00:34.827Z\"\n  },\n  \"__v\": 16\n},\n{\n  \"_id\": {\n    \"$oid\": \"679bbe4cd8868e0b6de16558\"\n  },\n  \"policyholderId\": [],\n  \"policyName\": \"Travel Insurance\",\n  \"policyDescription\": \"Covers trip cancellations, lost luggage, medical emergencies, and travel-related risks.\",\n  \"coverageAmount\": 75000,\n  \"startDate\": {\n    \"$date\": \"2023-05-20T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2026-05-20T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.icicilombard.com/WebPages/Resources/images/insurance-information/Tips%20for%20travel%20insurance.jpg\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T18:00:44.569Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-24T08:17:44.674Z\"\n  },\n  \"__v\": 8\n},\n{\n  \"_id\": {\n    \"$oid\": \"679bbe5ad8868e0b6de1655a\"\n  },\n  \"policyholderId\": [\n    {\n      \"userId\": {\n        \"$oid\": \"679e1ace28040c47690d4d21\"\n      },\n      \"gender\": \"Male\",\n      \"age\": 34,\n      \"medicalHistory\": \"gyg\",\n      \"startDate\": {\n        \"$date\": \"2025-02-28T00:00:00.000Z\"\n      },\n      \"endDate\": {\n        \"$date\": \"2025-03-13T00:00:00.000Z\"\n      },\n      \"_id\": {\n        \"$oid\": \"67bff514997014a4b7b2463a\"\n      }\n    }\n  ],\n  \"policyName\": \"Life Insurance\",\n  \"policyDescription\": \"Provides financial security for your family in case of an unfortunate event.\",\n  \"coverageAmount\": 500000,\n  \"startDate\": {\n    \"$date\": \"2021-12-10T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2041-12-10T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.policybachat.com/ArticlesImages/1297.jpg\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T18:00:58.440Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-27T05:16:04.677Z\"\n  },\n  \"__v\": 10\n},\n{\n  \"_id\": {\n    \"$oid\": \"679bbe6bd8868e0b6de1655c\"\n  },\n  \"policyholderId\": [],\n  \"policyName\": \"Business Insurance\",\n  \"policyDescription\": \"Covers business assets, liability, and employee-related risks.\",\n  \"coverageAmount\": 300000,\n  \"startDate\": {\n    \"$date\": \"2022-09-01T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2027-09-01T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://media.licdn.com/dms/image/v2/C5112AQHC3dhVhfoLKA/article-cover_image-shrink_600_2000/article-cover_image-shrink_600_2000/0/1520115901335?e=2147483647&v=beta&t=ODD2guDd6qzuGlLSaoyzaPQwTgVTrE4JxqbOtearcqk\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T18:01:15.217Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-25T08:07:58.782Z\"\n  },\n  \"__v\": 2\n},\n{\n  \"_id\": {\n    \"$oid\": \"679bbe7cd8868e0b6de1655e\"\n  },\n  \"policyholderId\": [],\n  \"policyName\": \"Education Insurance\",\n  \"policyDescription\": \"Ensures your childâ€™s future education expenses are covered.\",\n  \"coverageAmount\": 200000,\n  \"startDate\": {\n    \"$date\": \"2023-07-15T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2040-07-15T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.renewbuy.com/sites/default/files/2022-12/Child-Insurance.png\",\n  \"createdAt\": {\n    \"$date\": \"2025-01-30T18:01:32.528Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-25T07:51:23.752Z\"\n  },\n  \"__v\": 10\n},\n{\n  \"_id\": {\n    \"$oid\": \"67aafbcf3cfac989fa257341\"\n  },\n  \"policyName\": \"General Insurance\",\n  \"policyDescription\": \"General Insurance provides comprehensive health coverage ensuring financial protection against medical emergencies. It includes cashless hospitalization and hassle-free claim settlements.\",\n  \"coverageAmount\": 450000,\n  \"startDate\": {\n    \"$date\": \"2025-02-11T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2027-10-13T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.ethika.co.in/wp-content/uploads/2022/07/GENERAL-INSURANCE.png\",\n  \"policyholderId\": [],\n  \"createdAt\": {\n    \"$date\": \"2025-02-11T07:27:11.099Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-11T07:30:41.619Z\"\n  },\n  \"__v\": 1\n},\n{\n  \"_id\": {\n    \"$oid\": \"67b8130622f9ad1725c2ee8a\"\n  },\n  \"policyName\": \"Marine Insurance\",\n  \"policyDescription\": \"Provides coverage for ships, cargo, and freight against risks like accidents, piracy, and natural disasters during transit.\\r\\n\",\n  \"coverageAmount\": 7500000,\n  \"startDate\": {\n    \"$date\": \"2025-02-21T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2028-11-28T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.probusinsurance.com/wp-content/uploads/2021/12/Marine_insurance_inner.png\",\n  \"policyholderId\": [],\n  \"createdAt\": {\n    \"$date\": \"2025-02-21T05:45:43.013Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-25T08:05:36.574Z\"\n  },\n  \"__v\": 2\n},\n{\n  \"_id\": {\n    \"$oid\": \"67b813b79614ab9dbc4796de\"\n  },\n  \"policyName\": \"Crop Insurance\",\n  \"policyDescription\": \"Provides financial support to farmers against losses due to natural calamities, pests, or disease outbreaks.\",\n  \"coverageAmount\": 500000,\n  \"startDate\": {\n    \"$date\": \"2025-02-28T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2027-09-13T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.bajajallianz.com/blog/wp-content/uploads/2022/07/pmfby-crop-insurance-scheme-benefits-for-farmers.png\",\n  \"policyholderId\": [],\n  \"createdAt\": {\n    \"$date\": \"2025-02-21T05:48:39.698Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-21T05:48:39.698Z\"\n  },\n  \"__v\": 0\n},\n{\n  \"_id\": {\n    \"$oid\": \"67b814a85bb37ef258523ab6\"\n  },\n  \"policyName\": \"Pet Insurance\",\n  \"policyDescription\": \"Covers veterinary expenses for illnesses, injuries, and routine care of pets.\",\n  \"coverageAmount\": 250000,\n  \"startDate\": {\n    \"$date\": \"2025-02-21T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2025-10-15T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://consumer-voice.org/wp-content/uploads/2021/03/pet-insurance.png\",\n  \"policyholderId\": [],\n  \"createdAt\": {\n    \"$date\": \"2025-02-21T05:52:40.519Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-21T05:52:40.519Z\"\n  },\n  \"__v\": 0\n},\n{\n  \"_id\": {\n    \"$oid\": \"67b815115bb37ef258523ab8\"\n  },\n  \"policyName\": \"Event Insurance\",\n  \"policyDescription\": \"Protects against financial losses due to cancellations, accidents, or liabilities at events.\",\n  \"coverageAmount\": 1000000,\n  \"startDate\": {\n    \"$date\": \"2025-03-05T00:00:00.000Z\"\n  },\n  \"endDate\": {\n    \"$date\": \"2025-05-03T00:00:00.000Z\"\n  },\n  \"imageUrl\": \"https://www.ethika.co.in/wp-content/themes/ultrabootstrap-child/assets/event-insurance/3.png\",\n  \"policyholderId\": [],\n  \"createdAt\": {\n    \"$date\": \"2025-02-21T05:54:25.536Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2025-02-21T06:18:29.796Z\"\n  },\n  \"__v\": 1\n}]\n\n\nthis is my data and based on this data you will suggest polcies to the user\n\nuser will enter the age and needs and based on that you will suggest user the policies, you will only tell user the policy name its description and its coverage amount only.\n\n\nif age is less that 18 or greater than 70 tell that you are not eligble for buying policies\n\ndo not add special characters in the output or any brackets please just plain text\n\nif users enters prompt other than policies data please say you are not entitled to answer other than policies data\n\n\n\n"},
          ],
        },
        {
          role: "model",
          parts: [
            {text: "Okay, I understand. I will only provide policy suggestions based on the user's age and needs, drawing from the data you provided. I will only output the policy name, description, and coverage amount. I will also handle age ineligibility and out-of-scope requests as specified.\n\n**Example Interaction:**\n\n**User:** I am 35 years old and need a policy that covers my family's future in case something happens to me.\n\n**Response:**\n\nLife Insurance: Provides financial security for your family in case of an unfortunate event. Coverage Amount: 500000\n\n**User:** I am 60 and want to protect my house.\n\n**Response:**\n\nHome Insurance: Protects your home from fire, theft, and natural calamities. Coverage Amount: 200000\n\n**User:** I am 75 years old.\n\n**Response:**\n\nYou are not eligible for buying policies.\n\n**User:** Tell me about the weather.\n\n**Response:**\n\nI am not entitled to answer other than policies data.\n"},
          ],
        },
      ],
    });
  
    const result = await chatSession.sendMessage(prompt);
    return result.response.text();
  }

module.exports = run;